WITH 
TOURNAMENT_AVERAGES AS (
    SELECT TOURNAMENT_NAME,
        AVG(SG_PUTT) AS TOURN_AVG_SG_PUTT,
        AVG(SG_OFF_THE_TEE) AS TOURN_AVG_SG_OFF_THE_TEE,
        AVG(SG_APPROACH) AS TOURN_AVG_SG_APPROACH,
        AVG(SG_AROUND_THE_GREEN) AS TOURN_AVG_SG_AROUND_THE_GREEN,
        AVG(TOTAL_SCORE_TO_PAR) AS TOURN_AVG_TOTAL_SCORE_TO_PAR
    FROM PLAYER_TOURNAMENT_RESULTS_V3
    GROUP BY 1
),
ADJUSTED_METRICS AS (
    SELECT PLAYER_TOURNAMENT_RESULTS_V3.TOURNAMENT_NAME, TOURNAMENT_DATE, PLAYER_NAME,
        SG_PUTT, TOURN_AVG_SG_PUTT, SG_PUTT - TOURN_AVG_SG_PUTT AS ADJ_SG_PUTT
    FROM PLAYER_TOURNAMENT_RESULTS_V3
    INNER JOIN TOURNAMENT_AVERAGES ON PLAYER_TOURNAMENT_RESULTS_V3.TOURNAMENT_NAME = TOURNAMENT_AVERAGES.TOURNAMENT_NAME
    ORDER BY PLAYER_NAME, PLAYER_TOURNAMENT_RESULTS_V3.TOURNAMENT_DATE
),
LAGGED_ADJUSTED_METRICS AS (
    SELECT PLAYER_NAME, TOURNAMENT_DATE, ADJ_SG_PUTT,
        LAG(TOURNAMENT_DATE, 1) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P1_DATE,
        LAG(ADJ_SG_PUTT, 1) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P1_ADJ_SG,
        LAG(TOURNAMENT_DATE, 2) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P2_DATE,
        LAG(ADJ_SG_PUTT, 2) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P2_ADJ_SG,
        LAG(TOURNAMENT_DATE, 3) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P3_DATE,
        LAG(ADJ_SG_PUTT, 3) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P3_ADJ_SG,
        LAG(TOURNAMENT_DATE, 4) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P4_DATE,
        LAG(ADJ_SG_PUTT, 4) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P4_ADJ_SG,
        LAG(TOURNAMENT_DATE, 5) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P5_DATE,
        LAG(ADJ_SG_PUTT, 5) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P5_ADJ_SG,
        LAG(TOURNAMENT_DATE, 6) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P6_DATE,
        LAG(ADJ_SG_PUTT, 6) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P6_ADJ_SG,
        LAG(TOURNAMENT_DATE, 7) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P7_DATE,
        LAG(ADJ_SG_PUTT, 7) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P7_ADJ_SG,
        LAG(TOURNAMENT_DATE, 8) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P8_DATE,
        LAG(ADJ_SG_PUTT, 8) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P8_ADJ_SG,
        LAG(TOURNAMENT_DATE, 9) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P9_DATE,
        LAG(ADJ_SG_PUTT, 9) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P9_ADJ_SG,
        LAG(TOURNAMENT_DATE, 10) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P10_DATE,
        LAG(ADJ_SG_PUTT, 10) OVER (PARTITION BY PLAYER_NAME ORDER BY TOURNAMENT_DATE) AS P10_ADJ_SG
    FROM ADJUSTED_METRICS
)

SELECT *
FROM LAGGED_ADJUSTED_METRICS
WHERE P10_ADJ_SG IS NOT NULL
ORDER BY PLAYER_NAME, TOURNAMENT_DATE
